<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quarantine Management Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header {
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 20px;
            margin-bottom: 20px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 6px;
            border-left: 4px solid #007bff;
        }
        .stat-card.danger {
            border-left-color: #dc3545;
        }
        .stat-card.warning {
            border-left-color: #ffc107;
        }
        .stat-card.success {
            border-left-color: #28a745;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        .actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-warning {
            background: #ffc107;
            color: black;
        }
        .files-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .files-table th,
        .files-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .files-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .threat-level {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }
        .threat-low { background: #d4edda; color: #155724; }
        .threat-medium { background: #fff3cd; color: #856404; }
        .threat-high { background: #f8d7da; color: #721c24; }
        .threat-critical { background: #f5c6cb; color: #491217; }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîí Quarantine Management Dashboard</h1>
            <p>Monitor and manage quarantined files detected by the security system</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="total-files">{{ stats.total_files }}</div>
                <div class="stat-label">Total Quarantined Files</div>
            </div>
            <div class="stat-card danger">
                <div class="stat-number" id="critical-files">{{ stats.threat_levels.CRITICAL|default:0 }}</div>
                <div class="stat-label">Critical Threats</div>
            </div>
            <div class="stat-card warning">
                <div class="stat-number" id="recent-files">{{ stats.recent_files }}</div>
                <div class="stat-label">Recent Files (7 days)</div>
            </div>
            <div class="stat-card success">
                <div class="stat-number" id="total-size">{{ stats.total_size|filesizeformat }}</div>
                <div class="stat-label">Total Size</div>
            </div>
        </div>

        <div class="actions">
            <button class="btn btn-primary" onclick="refreshFiles()">üîÑ Refresh</button>
            <button class="btn btn-warning" onclick="cleanupOldFiles()">üßπ Cleanup Old Files</button>
            <button class="btn btn-danger" onclick="exportReport()">üìä Export Report</button>
        </div>

        <div id="files-container">
            <div class="loading">Loading quarantined files...</div>
        </div>
    </div>

    <script>
        let currentFiles = [];

        // Load files on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadQuarantinedFiles();
        });

        async function loadQuarantinedFiles() {
            try {
                const response = await fetch('/quarantine/api/files/');
                const data = await response.json();
                
                if (response.ok) {
                    currentFiles = data.files;
                    displayFiles(data.files);
                } else {
                    showError('Failed to load quarantined files: ' + data.error);
                }
            } catch (error) {
                showError('Error loading files: ' + error.message);
            }
        }

        function displayFiles(files) {
            const container = document.getElementById('files-container');
            
            if (files.length === 0) {
                container.innerHTML = '<div class="loading">No quarantined files found.</div>';
                return;
            }

            let html = `
                <table class="files-table">
                    <thead>
                        <tr>
                            <th>Original Name</th>
                            <th>Quarantine Date</th>
                            <th>Size</th>
                            <th>Threat Level</th>
                            <th>Threats</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            files.forEach(file => {
                const date = new Date(file.quarantine_date).toLocaleString();
                const size = formatFileSize(file.file_size);
                const threatClass = 'threat-' + file.threat_level.toLowerCase();
                
                html += `
                    <tr>
                        <td title="${file.original_name}">${truncateText(file.original_name, 30)}</td>
                        <td>${date}</td>
                        <td>${size}</td>
                        <td><span class="threat-level ${threatClass}">${file.threat_level}</span></td>
                        <td>${file.threat_count}</td>
                        <td>
                            <button class="btn btn-primary" onclick="viewDetails('${file.id}')">üëÅÔ∏è View</button>
                            <button class="btn btn-warning" onclick="restoreFile('${file.id}')">‚Ü©Ô∏è Restore</button>
                            <button class="btn btn-danger" onclick="deleteFile('${file.id}')">üóëÔ∏è Delete</button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        async function viewDetails(fileId) {
            try {
                const response = await fetch(`/quarantine/api/files/${fileId}/`);
                const data = await response.json();
                
                if (response.ok) {
                    showFileDetails(data);
                } else {
                    showError('Failed to load file details: ' + data.error);
                }
            } catch (error) {
                showError('Error loading file details: ' + error.message);
            }
        }

        function showFileDetails(data) {
            const validation = data.validation_result || {};
            const suspicious = data.suspicious_content || [];
            
            let detailsHtml = `
                <div style="background: white; padding: 20px; border-radius: 8px; max-width: 800px; margin: 20px auto;">
                    <h3>üìÑ File Details</h3>
                    <p><strong>Original Name:</strong> ${data.original_filename}</p>
                    <p><strong>Quarantine Date:</strong> ${new Date(data.quarantine_timestamp).toLocaleString()}</p>
                    <p><strong>File Size:</strong> ${formatFileSize(data.file_size)}</p>
                    <p><strong>Extension:</strong> ${validation.extension || 'Unknown'}</p>
                    <p><strong>Threat Level:</strong> <span class="threat-level threat-${validation.threat_level?.toLowerCase()}">${validation.threat_level}</span></p>
                    
                    <h4>üö® Detected Threats (${suspicious.length})</h4>
                    <ul>
            `;
            
            suspicious.slice(0, 10).forEach(threat => {
                detailsHtml += `<li><strong>${threat.pattern}:</strong> ${threat.match} (Position: ${threat.position})</li>`;
            });
            
            if (suspicious.length > 10) {
                detailsHtml += `<li>... and ${suspicious.length - 10} more threats</li>`;
            }
            
            detailsHtml += `
                    </ul>
                    <button class="btn btn-primary" onclick="closeModal()">Close</button>
                </div>
            `;
            
            showModal(detailsHtml);
        }

        async function restoreFile(fileId) {
            if (!confirm('Are you sure you want to restore this file? It will be moved to the uploads directory.')) {
                return;
            }

            try {
                const response = await fetch(`/quarantine/api/files/${fileId}/restore/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify({})
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('File restored successfully: ' + data.restored_filename);
                    loadQuarantinedFiles(); // Refresh the list
                } else {
                    if (data.requires_force) {
                        if (confirm(`${data.error} Do you want to force restore?`)) {
                            // Retry with force
                            const forceResponse = await fetch(`/quarantine/api/files/${fileId}/restore/`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': getCsrfToken()
                                },
                                body: JSON.stringify({force: true})
                            });
                            
                            const forceData = await forceResponse.json();
                            if (forceResponse.ok) {
                                alert('File force restored: ' + forceData.restored_filename);
                                loadQuarantinedFiles();
                            } else {
                                showError('Force restore failed: ' + forceData.error);
                            }
                        }
                    } else {
                        showError('Restore failed: ' + data.error);
                    }
                }
            } catch (error) {
                showError('Error restoring file: ' + error.message);
            }
        }

        async function deleteFile(fileId) {
            if (!confirm('Are you sure you want to permanently delete this quarantined file? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/quarantine/api/files/${fileId}/delete/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCsrfToken()
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('File deleted successfully: ' + data.deleted_filename);
                    loadQuarantinedFiles(); // Refresh the list
                } else {
                    showError('Delete failed: ' + data.error);
                }
            } catch (error) {
                showError('Error deleting file: ' + error.message);
            }
        }

        async function cleanupOldFiles() {
            const days = prompt('Delete files older than how many days?', '30');
            if (!days || isNaN(days)) return;

            try {
                const response = await fetch('/quarantine/api/cleanup/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify({days: parseInt(days)})
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    if (data.requires_confirmation) {
                        if (confirm(`${data.message}. Continue with deletion?`)) {
                            // Confirm cleanup
                            const confirmResponse = await fetch('/quarantine/api/cleanup/', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': getCsrfToken()
                                },
                                body: JSON.stringify({days: parseInt(days), force: true})
                            });
                            
                            const confirmData = await confirmResponse.json();
                            if (confirmResponse.ok) {
                                alert(confirmData.message);
                                loadQuarantinedFiles();
                            } else {
                                showError('Cleanup failed: ' + confirmData.error);
                            }
                        }
                    } else {
                        alert(data.message);
                        loadQuarantinedFiles();
                    }
                } else {
                    showError('Cleanup failed: ' + data.error);
                }
            } catch (error) {
                showError('Error during cleanup: ' + error.message);
            }
        }

        function refreshFiles() {
            loadQuarantinedFiles();
        }

        function exportReport() {
            // Simple CSV export
            let csv = 'Original Name,Quarantine Date,File Size,Threat Level,Threat Count\n';
            currentFiles.forEach(file => {
                csv += `"${file.original_name}","${file.quarantine_date}",${file.file_size},"${file.threat_level}",${file.threat_count}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `quarantine_report_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Utility functions
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function truncateText(text, maxLength) {
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }

        function showError(message) {
            const container = document.getElementById('files-container');
            container.innerHTML = `<div class="error">‚ùå ${message}</div>`;
        }

        function showModal(content) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 1000; display: flex;
                align-items: center; justify-content: center;
            `;
            modal.innerHTML = content;
            modal.onclick = (e) => {
                if (e.target === modal) closeModal();
            };
            document.body.appendChild(modal);
            window.currentModal = modal;
        }

        function closeModal() {
            if (window.currentModal) {
                document.body.removeChild(window.currentModal);
                window.currentModal = null;
            }
        }

        function getCsrfToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
        }
    </script>
</body>
</html>""