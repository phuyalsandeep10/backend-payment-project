<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRS Error Monitoring Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .metric-card {
            @apply bg-white rounded-lg shadow-md p-6 border-l-4;
        }
        .metric-card.healthy { @apply border-green-500; }
        .metric-card.warning { @apply border-yellow-500; }
        .metric-card.critical { @apply border-red-500; }
        
        .health-score-100 { @apply text-green-600; }
        .health-score-80 { @apply text-yellow-600; }
        .health-score-60 { @apply text-orange-600; }
        .health-score-0 { @apply text-red-600; }
        
        .status-normal { @apply bg-green-100 text-green-800; }
        .status-attention { @apply bg-yellow-100 text-yellow-800; }
        .status-warning { @apply bg-orange-100 text-orange-800; }
        .status-critical { @apply bg-red-100 text-red-800; }
        
        .auto-refresh { animation: spin 2s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-3xl font-bold text-gray-800">Error Monitoring Dashboard</h1>
                <div class="flex items-center space-x-4">
                    <!-- Time Period Selector -->
                    <select id="timePeriod" class="px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="1" {% if hours == 1 %}selected{% endif %}>Last Hour</option>
                        <option value="24" {% if hours == 24 %}selected{% endif %}>Last 24 Hours</option>
                        <option value="168" {% if hours == 168 %}selected{% endif %}>Last 7 Days</option>
                    </select>
                    
                    <!-- Auto Refresh Toggle -->
                    <button id="autoRefresh" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <span id="refreshIcon">ðŸ”„</span> Auto Refresh
                    </button>
                    
                    <!-- Manual Refresh -->
                    <button id="manualRefresh" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500">
                        Refresh Now
                    </button>
                </div>
            </div>
            
            <!-- System Status Banner -->
            <div id="statusBanner" class="p-4 rounded-lg status-{{ health_metrics.alert_status }}">
                <div class="flex items-center">
                    <span class="text-lg font-semibold">System Status: </span>
                    <span class="ml-2 px-3 py-1 rounded-full text-sm font-medium status-{{ health_metrics.alert_status }}">
                        {{ health_metrics.alert_status|title }}
                    </span>
                    <span class="ml-4 text-sm">
                        Health Score: <span class="font-bold health-score-{{ overview.health_score|floatformat:0 }}">{{ overview.health_score }}/100</span>
                    </span>
                </div>
            </div>
        </div>

        <!-- Overview Metrics -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Total Error Clusters -->
            <div class="metric-card {% if overview.active_error_clusters > 10 %}critical{% elif overview.active_error_clusters > 5 %}warning{% else %}healthy{% endif %}">
                <div class="flex items-center">
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-600">Active Error Clusters</p>
                        <p class="text-2xl font-bold text-gray-900">{{ overview.active_error_clusters }}</p>
                        <p class="text-xs text-gray-500">of {{ overview.total_error_clusters }} total</p>
                    </div>
                    <div class="p-3 rounded-full bg-blue-100">
                        <span class="text-2xl">ðŸš¨</span>
                    </div>
                </div>
            </div>

            <!-- Error Rate -->
            <div class="metric-card {% if overview.error_rate > 10 %}critical{% elif overview.error_rate > 5 %}warning{% else %}healthy{% endif %}">
                <div class="flex items-center">
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-600">Error Rate</p>
                        <p class="text-2xl font-bold text-gray-900">{{ overview.error_rate }}/hr</p>
                        <p class="text-xs text-gray-500">{{ overview.total_error_occurrences }} total errors</p>
                    </div>
                    <div class="p-3 rounded-full bg-red-100">
                        <span class="text-2xl">ðŸ“ˆ</span>
                    </div>
                </div>
            </div>

            <!-- Critical Errors -->
            <div class="metric-card {% if overview.critical_errors > 0 %}critical{% else %}healthy{% endif %}">
                <div class="flex items-center">
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-600">Critical Errors</p>
                        <p class="text-2xl font-bold text-gray-900">{{ overview.critical_errors }}</p>
                        <p class="text-xs text-gray-500">Last {{ overview.time_period_hours }}h</p>
                    </div>
                    <div class="p-3 rounded-full bg-red-100">
                        <span class="text-2xl">ðŸ’¥</span>
                    </div>
                </div>
            </div>

            <!-- New Patterns -->
            <div class="metric-card {% if overview.new_error_patterns > 5 %}warning{% else %}healthy{% endif %}">
                <div class="flex items-center">
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-600">New Patterns</p>
                        <p class="text-2xl font-bold text-gray-900">{{ overview.new_error_patterns }}</p>
                        <p class="text-xs text-gray-500">First time seen</p>
                    </div>
                    <div class="p-3 rounded-full bg-yellow-100">
                        <span class="text-2xl">ðŸ†•</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Error Trends Chart -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Error Trends</h3>
                <canvas id="errorTrendsChart" width="400" height="200"></canvas>
                <div class="mt-4 text-sm text-gray-600">
                    <span class="inline-block w-3 h-3 bg-red-500 rounded-full mr-2"></span>
                    Trend: <span class="font-medium">{{ trends.trend_direction|title }}</span>
                    {% if trends.peak_hour %}
                    | Peak: {{ trends.peak_hour }}
                    {% endif %}
                </div>
            </div>

            <!-- Error Distribution -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Error Distribution by Severity</h3>
                <canvas id="severityChart" width="400" height="200"></canvas>
                <div class="mt-4 grid grid-cols-2 gap-4 text-sm">
                    {% for severity, count in overview.severity_distribution.items %}
                    <div class="flex items-center justify-between">
                        <span class="capitalize">{{ severity }}:</span>
                        <span class="font-medium">{{ count }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Detailed Tables Row -->
        <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 mb-8">
            <!-- Top Errors Table -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Top Error Patterns</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="text-left py-3 px-2">Error Type</th>
                                <th class="text-left py-3 px-2">Location</th>
                                <th class="text-center py-3 px-2">Count</th>
                                <th class="text-center py-3 px-2">Users</th>
                                <th class="text-center py-3 px-2">Impact</th>
                                <th class="text-center py-3 px-2">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for error in top_errors %}
                            <tr class="border-b border-gray-100 hover:bg-gray-50">
                                <td class="py-3 px-2">
                                    <div class="font-medium">{{ error.error_type }}</div>
                                    <div class="text-xs text-gray-500">{{ error.error_pattern|truncatechars:30 }}</div>
                                </td>
                                <td class="py-3 px-2 text-xs">{{ error.error_location|truncatechars:20 }}</td>
                                <td class="py-3 px-2 text-center">
                                    <span class="font-medium">{{ error.occurrence_count }}</span>
                                </td>
                                <td class="py-3 px-2 text-center">{{ error.affected_users }}</td>
                                <td class="py-3 px-2 text-center">
                                    <span class="px-2 py-1 text-xs rounded-full 
                                        {% if error.severity_level == 'critical' %}bg-red-100 text-red-800
                                        {% elif error.severity_level == 'high' %}bg-orange-100 text-orange-800
                                        {% elif error.severity_level == 'medium' %}bg-yellow-100 text-yellow-800
                                        {% else %}bg-green-100 text-green-800{% endif %}">
                                        {{ error.severity_level|title }}
                                    </span>
                                </td>
                                <td class="py-3 px-2 text-center">
                                    <button class="text-blue-600 hover:text-blue-800 text-xs" 
                                            onclick="viewErrorDetails('{{ error.signature_hash }}')">
                                        View
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- User Impact Analysis -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">User Impact Analysis</h3>
                
                <!-- Summary Stats -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="text-center p-4 bg-gray-50 rounded-lg">
                        <div class="text-2xl font-bold text-gray-900">{{ user_impact.total_affected_users }}</div>
                        <div class="text-sm text-gray-600">Users Affected</div>
                    </div>
                    <div class="text-center p-4 bg-gray-50 rounded-lg">
                        <div class="text-2xl font-bold text-gray-900">{{ user_impact.users_with_multiple_errors }}</div>
                        <div class="text-sm text-gray-600">Repeat Issues</div>
                    </div>
                </div>

                <!-- Organization Impact -->
                {% if user_impact.organization_impact %}
                <div class="mb-4">
                    <h4 class="font-medium text-gray-800 mb-2">Organization Impact</h4>
                    <div class="space-y-2">
                        {% for org_id, count in user_impact.organization_impact.items %}
                        <div class="flex justify-between items-center text-sm">
                            <span>Org {{ org_id }}</span>
                            <span class="px-2 py-1 bg-gray-100 rounded">{{ count }} errors</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Most Affected Users -->
                <div>
                    <h4 class="font-medium text-gray-800 mb-2">Most Affected Users</h4>
                    <div class="space-y-2 max-h-40 overflow-y-auto">
                        {% for user_id, error_count in user_impact.most_affected_users %}
                        <div class="flex justify-between items-center text-sm">
                            <span>User {{ user_id }}</span>
                            <span class="px-2 py-1 bg-red-100 text-red-800 rounded text-xs">{{ error_count }} errors</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- System Health Metrics -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">System Health Metrics</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <div class="text-lg font-bold">{{ health_metrics.system_stability_score }}</div>
                    <div class="text-sm text-gray-600">Stability Score</div>
                </div>
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <div class="text-lg font-bold">{{ health_metrics.error_rate_24h }}/hr</div>
                    <div class="text-sm text-gray-600">24h Error Rate</div>
                </div>
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <div class="text-lg font-bold">{{ health_metrics.resolved_errors_24h }}</div>
                    <div class="text-sm text-gray-600">Resolved (24h)</div>
                </div>
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <div class="text-lg font-bold">{{ health_metrics.performance_impact|title }}</div>
                    <div class="text-sm text-gray-600">Performance Impact</div>
                </div>
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <div class="text-lg font-bold status-{{ health_metrics.alert_status }}">{{ health_metrics.alert_status|title }}</div>
                    <div class="text-sm text-gray-600">Alert Level</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Details Modal -->
    <div id="errorModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="bg-white rounded-lg shadow-lg max-w-4xl w-full max-h-screen overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Error Details</h3>
                        <button onclick="closeErrorModal()" class="text-gray-400 hover:text-gray-600">
                            <span class="text-2xl">Ã—</span>
                        </button>
                    </div>
                    <div id="errorModalContent">
                        Loading...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dashboard JavaScript
        let autoRefreshEnabled = false;
        let autoRefreshInterval;

        // Initialize charts
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            setupEventListeners();
        });

        function initializeCharts() {
            // Error Trends Chart
            const trendsCtx = document.getElementById('errorTrendsChart').getContext('2d');
            new Chart(trendsCtx, {
                type: 'line',
                data: {
                    labels: {{ trends.labels|safe }},
                    datasets: [{
                        label: 'Error Count',
                        data: {{ trends.error_counts|safe }},
                        borderColor: 'rgb(239, 68, 68)',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Severity Distribution Chart
            const severityCtx = document.getElementById('severityChart').getContext('2d');
            const severityData = {{ overview.severity_distribution|safe }};
            new Chart(severityCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(severityData),
                    datasets: [{
                        data: Object.values(severityData),
                        backgroundColor: [
                            '#ef4444', // critical - red
                            '#f97316', // high - orange
                            '#eab308', // medium - yellow
                            '#22c55e'  // low - green
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function setupEventListeners() {
            // Time period change
            document.getElementById('timePeriod').addEventListener('change', function() {
                const hours = this.value;
                window.location.href = `?hours=${hours}`;
            });

            // Auto refresh toggle
            document.getElementById('autoRefresh').addEventListener('click', toggleAutoRefresh);
            
            // Manual refresh
            document.getElementById('manualRefresh').addEventListener('click', refreshDashboard);
        }

        function toggleAutoRefresh() {
            autoRefreshEnabled = !autoRefreshEnabled;
            const button = document.getElementById('autoRefresh');
            const icon = document.getElementById('refreshIcon');

            if (autoRefreshEnabled) {
                button.classList.add('bg-green-500');
                button.classList.remove('bg-blue-500');
                icon.classList.add('auto-refresh');
                
                // Refresh every 30 seconds
                autoRefreshInterval = setInterval(refreshDashboard, 30000);
            } else {
                button.classList.remove('bg-green-500');
                button.classList.add('bg-blue-500');
                icon.classList.remove('auto-refresh');
                
                clearInterval(autoRefreshInterval);
            }
        }

        function refreshDashboard() {
            const hours = document.getElementById('timePeriod').value;
            
            fetch(`/admin/error-dashboard/api/?hours=${hours}`)
                .then(response => response.json())
                .then(data => {
                    updateDashboardData(data);
                })
                .catch(error => {
                    console.error('Failed to refresh dashboard:', error);
                });
        }

        function updateDashboardData(data) {
            // Update overview metrics
            // This would update the DOM with new data
            // Implementation depends on specific update requirements
            console.log('Updated dashboard data:', data);
        }

        function viewErrorDetails(signatureHash) {
            document.getElementById('errorModal').classList.remove('hidden');
            document.getElementById('errorModalContent').innerHTML = 'Loading...';
            
            fetch(`/admin/error-dashboard/error/${signatureHash}/?format=json`)
                .then(response => response.json())
                .then(data => {
                    displayErrorDetails(data);
                })
                .catch(error => {
                    document.getElementById('errorModalContent').innerHTML = 'Error loading details';
                });
        }

        function displayErrorDetails(data) {
            const content = `
                <div class="space-y-6">
                    <div class="border-b pb-4">
                        <h4 class="font-semibold text-lg">${data.cluster.signature.error_type}</h4>
                        <p class="text-gray-600">${data.cluster.signature.error_location}</p>
                        <p class="text-sm text-gray-500">${data.cluster.signature.error_pattern}</p>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="text-center p-3 bg-gray-50 rounded">
                            <div class="font-bold text-lg">${data.statistics.total_occurrences}</div>
                            <div class="text-sm text-gray-600">Total Occurrences</div>
                        </div>
                        <div class="text-center p-3 bg-gray-50 rounded">
                            <div class="font-bold text-lg">${data.statistics.unique_users_affected}</div>
                            <div class="text-sm text-gray-600">Users Affected</div>
                        </div>
                        <div class="text-center p-3 bg-gray-50 rounded">
                            <div class="font-bold text-lg">${data.statistics.impact_score}</div>
                            <div class="text-sm text-gray-600">Impact Score</div>
                        </div>
                        <div class="text-center p-3 bg-gray-50 rounded">
                            <div class="font-bold text-lg">${data.statistics.severity_level}</div>
                            <div class="text-sm text-gray-600">Severity</div>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <h5 class="font-semibold mb-2">Recent Occurrences</h5>
                            <div class="max-h-40 overflow-y-auto">
                                ${data.cluster.occurrences.map(occ => `
                                    <div class="text-sm border-b py-2">
                                        <span class="text-gray-500">${new Date(occ.timestamp).toLocaleString()}</span>
                                        <span class="ml-2">${occ.request_method} ${occ.request_path}</span>
                                        ${occ.user_id ? `<span class="ml-2 text-blue-600">User ${occ.user_id}</span>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="flex space-x-2">
                            <button onclick="resolveError('${data.cluster.signature.signature_hash}')" 
                                    class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                                Mark as Resolved
                            </button>
                            <button onclick="investigateError('${data.cluster.signature.signature_hash}')" 
                                    class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600">
                                Investigate
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('errorModalContent').innerHTML = content;
        }

        function closeErrorModal() {
            document.getElementById('errorModal').classList.add('hidden');
        }

        function resolveError(signatureHash) {
            fetch(`/admin/error-dashboard/action/${signatureHash}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: 'action=resolve'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Error marked as resolved');
                    closeErrorModal();
                    refreshDashboard();
                } else {
                    alert('Failed to resolve error');
                }
            });
        }

        function investigateError(signatureHash) {
            fetch(`/admin/error-dashboard/action/${signatureHash}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: 'action=investigate'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Error marked as under investigation');
                    closeErrorModal();
                    refreshDashboard();
                } else {
                    alert('Failed to update error status');
                }
            });
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</body>
</html>
